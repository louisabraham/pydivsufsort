name: Build and upload
on:
  push:
    branches: master
    paths:
      - "setup.py"
      - .github/workflows/build-and-upload.yml

permissions:
  contents: write

jobs:
  testing:
    uses: ./.github/workflows/test.yml
  build_linux_macos_wheels:
    needs: testing
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux native x86_64 (also builds sdist)
          - os: ubuntu-latest
            archs: x86_64
            build: "*"
            build_sdist: true
          # Linux native aarch64
          - os: ubuntu-24.04-arm
            archs: aarch64
            build: "*"
            build_sdist: false
          # macOS (cross-compilation)
          - os: macos-latest
            archs: x86_64 arm64
            build: "*"
            build_sdist: false
    steps:
      - name: Checkout Repository And Submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"
      - name: Install build and pip
        run: python -m pip install -U pip build
        shell: bash
      - name: Build Sdist
        if: matrix.build_sdist
        run: python -m build --sdist
        shell: bash
      - name: Install Cibuildwheel
        run: python -m pip install cibuildwheel
        shell: bash
      - name: Build Wheels
        env:
          CIBW_BEFORE_BUILD: pip install -U pip
          CIBW_SKIP: pp* *-musllinux_* *-manylinux_i686
          CIBW_BUILD_VERBOSITY: 1
          CIBW_TEST_REQUIRES: pytest
          CIBW_TEST_COMMAND: "pytest {project}/tests"
          CIBW_ARCHS: ${{ matrix.archs }}
          CIBW_BUILD: ${{ matrix.build }}
        run: |
          python -m cibuildwheel --output-dir wheelhouse
          ls wheelhouse/*
        shell: bash
      - name: Upload Builds
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: |
          python -m pip install twine
          if [ "${{ matrix.build_sdist }}" == "true" ]; then
            python -m twine upload --skip-existing dist/*
          fi
          python -m twine upload --skip-existing wheelhouse/*.whl
        shell: bash
  build_windows_wheels:
    needs: testing
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: win32
            skip: "pp* *-win_amd64"
            platform: "-A win32"
          - arch: amd64
            skip: "pp* *-win32"
            platform: "-A x64"
    steps:
      - name: Checkout Repository And Submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"
      - name: Install Cibuildwheel
        run: python -m pip install cibuildwheel
        shell: bash
      - name: Build Wheels
        env:
          CIBW_BEFORE_BUILD: bash ./build.sh
          CIBW_SKIP: ${{ matrix.skip }}
          CIBW_ENVIRONMENT: PLATFORM_OPTION='${{ matrix.platform }}'
          CIBW_BUILD_VERBOSITY: 1
          CIBW_TEST_REQUIRES: pytest
          CIBW_TEST_COMMAND: "pytest {project}/tests"
        run: |
          python -m cibuildwheel --output-dir wheelhouse
          ls wheelhouse/*
        shell: bash
      - name: Upload Builds
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: |
          python -m pip install twine
          python -m twine upload --skip-existing wheelhouse/*.whl
        shell: bash
  create_tag:
    needs: [build_linux_macos_wheels, build_windows_wheels]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Extract Version from setup.py
        id: get_version
        run: |
          VERSION=$(grep -Po 'version\s*=\s*"\K[0-9]+\.[0-9]+\.[0-9]+' setup.py || true)
          if [ -z "$VERSION" ]; then
            echo "ERROR: version not found in setup.py"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        shell: bash
      - name: Create and Push Tag
        run: |
          TAG="v${{ steps.get_version.outputs.VERSION }}"
          git rev-parse "refs/tags/$TAG" >/dev/null 2>&1 && exit 0
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag "$TAG"
          git push origin "$TAG"
        shell: bash
